<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ML5 01 · Cámara + Detección</title>

  <!-- ml5.js (versión fija para evitar cambios de API) -->
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    #wrap { position: relative; width: min(720px, 100%); }
    video, canvas { width: 100%; height: auto; border-radius: 10px; }
    canvas { position: absolute; left: 0; top: 0; }
    button { padding: 10px 12px; font-size: 14px; cursor: pointer; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; margin-bottom: 10px; }
    .badge { display:inline-block; border:1px solid #ccc; border-radius:999px; padding: 3px 10px; }
  </style>
</head>

<body>
  <h1>ML5 01 · Cámara en móvil + detección</h1>

  <div class="row">
    <button id="btnStart">Iniciar cámara</button>
    <span id="status" class="badge">Estado: esperando…</span>
    <span id="best" class="badge">Mejor detección: —</span>
  </div>

  <div id="wrap">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div>
   <h3> Explicación de cómo funciona el código</h3>

      <p>Esta página web sirve para usar la cámara del móvil o del ordenador y detectar objetos en tiempo real usando inteligencia artificial.
        Para que funcione, tiene que estar publicada en GitHub Pages, porque el navegador solo deja usar la cámara en páginas que tengan HTTPS, es decir, que sean seguras.
        Además, la cámara no se puede activar sola, por eso hay un botón. El navegador obliga a que el usuario haga una acción (como pulsar un botón) para dar permiso. </p>
    <p> En la parte de arriba del código se carga la librería ml5.js en la versión 0.12.2. Esta librería ya tiene modelos de inteligencia artificial preparados. 
      Nosotros usamos el modelo llamado COCO-SSD, que sirve para reconocer objetos comunes como personas, móviles, sillas, etc.
      Lo bueno es que no tenemos que programar la inteligencia artificial desde cero, solo usarla. </p>
    <p> En el HTML hay varias partes importantes. Primero, un botón para iniciar la cámara. Luego hay un elemento &lt;video&gt;, que es donde se ve la imagen en directo de la cámara. 
      Encima del vídeo hay un &lt;canvas&gt;, que es como una capa transparente donde se dibujan los rectángulos y los nombres de los objetos que se detectan. </p>
    <p> En el script, lo primero que se hace es guardar en variables los elementos del HTML usando document.getElementById.
      Después se crean algunas variables como “detector”, que guardará el modelo de detección, y “running”, que sirve para saber si el programa está funcionando o no. </p>
    <p> La función initCamera() es la que pide permiso para usar la cámara con navigator.mediaDevices.getUserMedia(). En el móvil intenta usar la cámara trasera.
      Cuando el vídeo ya está listo, el canvas se ajusta al mismo tamaño que el vídeo para que los dibujos coincidan bien con la imagen. </p> 
    <p> La función draw() se encarga de dibujar los resultados. 
      Primero borra lo que había antes y luego, por cada objeto detectado, dibuja un rectángulo alrededor y escribe el nombre del objeto junto con el porcentaje de seguridad. </p>
    <p> También hay una función llamada pickBest(), que simplemente mira cuál de los objetos detectados tiene mayor porcentaje de confianza y lo muestra como la mejor detección. </p> 
    <p> La detección no ocurre solo una vez, sino todo el tiempo. Eso lo hace la función loopDetect(), que analiza la imagen, dibuja los resultados y se vuelve a ejecutar continuamente usando requestAnimationFrame.
      Así parece que funciona en tiempo real. </p>
    <p> Cuando se pulsa el botón, primero se inicia la cámara, luego se carga el modelo de detección y finalmente empieza el análisis continuo. 
      Si hay algún error, aparece en pantalla y también en la consola. </p>

  </div>


  <script>
    const btnStart = document.getElementById("btnStart");
    const statusEl = document.getElementById("status");
    const bestEl = document.getElementById("best");

    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");

    let detector = null;
    let running = false;

    function setStatus(t) { statusEl.textContent = "Estado: " + t; }

    async function initCamera() {
      // En móvil, "environment" intenta usar la cámara trasera
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });

      video.srcObject = stream;

      await new Promise(res => video.onloadedmetadata = () => res());

      // Ajustar canvas al tamaño real del vídeo
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    function draw(detections) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 3;
      ctx.font = "16px system-ui, Arial";

      for (const d of detections) {
        ctx.strokeRect(d.x, d.y, d.width, d.height);
        const label = `${d.label} (${Math.round(d.confidence * 100)}%)`;
        ctx.fillText(label, d.x + 6, Math.max(16, d.y + 16));
      }
    }

    function pickBest(detections) {
      if (!detections || detections.length === 0) return null;
      let best = detections[0];
      for (const d of detections) {
        if (d.confidence > best.confidence) best = d;
      }
      return best;
    }

    function loopDetect() {
      if (!running || !detector) return;

      detector.detect(video, (err, results) => {
        if (err) {
          console.error(err);
          setStatus("error en detección (ver consola)");
          running = false;
          return;
        }

        draw(results);

        const best = pickBest(results);
        bestEl.textContent = best
          ? `Mejor detección: ${best.label} (${Math.round(best.confidence * 100)}%)`
          : "Mejor detección: —";

        requestAnimationFrame(loopDetect);
      });
    }

    btnStart.addEventListener("click", async () => {
      try {
        btnStart.disabled = true;

        setStatus("iniciando cámara…");
        await initCamera();

        setStatus("cargando modelo COCO-SSD…");
        detector = await ml5.objectDetector("cocossd");

        setStatus("detectando…");
        running = true;
        loopDetect();

      } catch (e) {
        console.error(e);
        setStatus(`error: ${e.name} — ${e.message}`);
        btnStart.disabled = false;
      }
    });
  </script>
</body>

</html>
